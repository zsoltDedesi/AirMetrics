services:
  backend:
    privileged: true
    build:
      context: .
      dockerfile: Dockerfile
    container_name: airmetrics-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./airmetrics.env:/app/airmetrics.env:ro
      - /var/lib/airmetrics:/var/lib/airmetrics
      - /sys/bus/w1/devices:/sys/bus/w1/devices:ro
      # Blinka platform detection (Raspberry Pi) needs access to device-tree.
      - /proc/device-tree:/proc/device-tree:ro
      - /sys/firmware/devicetree/base:/sys/firmware/devicetree/base:ro
    devices:
      - /dev/gpiomem:/dev/gpiomem
      - /dev/gpiochip0:/dev/gpiochip0
      # Some Blinka/GPIO backends probe /dev/mem.
      - /dev/mem:/dev/mem
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/api/health/live', timeout=3)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
